name: CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Poetry
        run: |
          pip install poetry

      - name: Install dependencies
        run: |
          poetry install --no-interaction --no-root

      - name: Run linters
        run: |
          poetry run black --check .
          poetry run isort --check-only .
          poetry run flake8 .

      - name: Run tests
        run: |
          poetry install --with dev --no-interaction --no-root
          poetry run pytest || echo "No tests found yet"
          
  trigger-automatic-training:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: lint-and-test
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Wait for Railway Deploy and Trigger Automatic Training
        env:
          HEALTH_URL: "https://backend-production-a6c92.up.railway.app/health" 
          TRAIN_URL: "https://backend-production-a6c92.up.railway.app/ml-model/training/internal/trigger-background?stage=prod"
          SECRET_TOKEN: ${{ secrets.ADMIN_SECRET }}
        run: |
          echo "‚è≥ Esperando 10 minutos para dar tiempo al deploy de Railway..."
          sleep 600

          echo "üîé Verificando si el servidor est√° deployado..."

          for i in {1..10}; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL")
            if [ "$HTTP_CODE" == "200" ]; then
              echo "‚úÖ Servidor online. Iniciando entrenamiento..."
              
              curl -X POST "$TRAIN_URL" \
                -H "accept: application/json" \
                -H "x-token: $SECRET_TOKEN" \
                --fail-with-body \
                --verbose
              
              exit 0
            fi
            echo "zzz... Servidor no responde a√∫n (C√≥digo: $HTTP_CODE). Reintentando en 10s..."
            sleep 10
          done

          echo "‚ùå El servidor no respondi√≥ a tiempo despu√©s del deploy."
          exit 1
